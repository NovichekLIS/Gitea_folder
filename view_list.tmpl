{{/* use grid layout, still use the old ID because there are many other CSS styles depending on this ID */}}
<div id="repo-files-table" {{if .HasFilesWithoutLatestCommit}}hx-indicator="#repo-files-table .repo-file-cell.message" hx-trigger="load" hx-swap="morph" hx-post="{{.LastCommitLoaderURL}}"{{end}}>
	<div class="repo-file-line repo-file-last-commit">
		{{template "repo/latest_commit" .}}
		<div>{{if and .LatestCommit .LatestCommit.Committer}}{{DateUtils.TimeSince .LatestCommit.Committer.When}}{{end}}</div>
	</div>
	
	{{$.FileIconPoolHTML}}
	{{if .HasParentPath}}
	<a class="repo-file-line parent-link silenced" href="{{.BranchLink}}{{if .ParentPath}}{{PathEscapeSegments .ParentPath}}{{end}}">
		{{index $.FileIcons ".."}} ..
	</a>
	{{end}}
	{{range $item := .Files}}
		<div class="repo-file-item">
			{{$entry := $item.Entry}}
			{{$commit := $item.Commit}}
			{{$submoduleFile := $item.SubmoduleFile}}
			<div class="repo-file-cell name muted-links {{if not $commit}}notready{{end}}">
				{{index $.FileIcons $entry.Name}}
				{{if $entry.IsSubModule}}
					{{$submoduleLink := $submoduleFile.SubmoduleWebLinkTree ctx}}
					{{if $submoduleLink}}
						<a class="entry-name" href="{{$submoduleLink.RepoWebLink}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						@ <a class="text primary" href="{{$submoduleLink.CommitWebLink}}">{{ShortSha $submoduleFile.RefID}}</a>
					{{else}}
						<span class="entry-name" title="{{$entry.Name}}">{{$entry.Name}}</span>
						@ {{ShortSha $submoduleFile.RefID}}
					{{end}}
				{{else}}
					{{if $entry.IsDir}}
						{{$subJumpablePathName := $entry.GetSubJumpablePathName}}
						
						{{/* Extract current branch from BranchLink */}}
						{{$currentBranch := ""}}
						{{if $.BranchLink}}
							{{$parts := StringUtils.Split $.BranchLink "/"}}
							{{range $i, $part := $parts}}
								{{if eq $part "branch"}}
									{{if lt (Eval $i "+" 1) (len $parts)}}
										{{$currentBranch = index $parts (Eval $i "+" 1)}}
									{{end}}
								{{end}}
							{{end}}
						{{end}}
						
						{{/* Compact folder download button (icon only, no dropdown arrow) */}}
						<button class="ui basic compact button repo-download-folder-icon" 
								data-tooltip-content='{{ctx.Locale.Tr "repo.download_folder"}}'
								title='{{ctx.Locale.Tr "repo.download_folder"}}'
								data-download-path="{{if $.TreePath}}{{$.TreePath}}/{{end}}{{$entry.Name}}"
								data-branch="{{$currentBranch}}">
							{{svg "octicon-download" 16}}
						</button>
						
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $subJumpablePathName}}" title="{{$subJumpablePathName}}">
							{{$subJumpablePathFields := StringUtils.Split $subJumpablePathName "/"}}
							{{$subJumpablePathFieldLast := (Eval (len $subJumpablePathFields) "-" 1)}}
							{{if eq $subJumpablePathFieldLast 0}}
								{{$subJumpablePathName}}
							{{else}}
								{{$subJumpablePathPrefixes := slice $subJumpablePathFields 0 $subJumpablePathFieldLast}}
								<span class="text light-2">{{StringUtils.Join $subJumpablePathPrefixes "/"}}</span>/{{index $subJumpablePathFields $subJumpablePathFieldLast}}
							{{end}}
						</a>
					{{else}}
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						{{if $entry.IsLink}}
							<a class="entry-symbol-link flex-text-inline" data-tooltip-content title="{{ctx.Locale.Tr "repo.find_file.follow_symlink"}}" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}?follow_symlink=1">{{svg "octicon-link" 12}}</a>
						{{end}}
					{{end}}
				{{end}}
			</div>
			<div class="repo-file-cell message commit-summary loading-icon-2px">
				{{if $commit}}
					{{$commitLink := printf "%s/commit/%s" $.RepoLink (PathEscape $commit.ID.String)}}
					{{ctx.RenderUtils.RenderCommitMessageLinkSubject $commit.Message $commitLink $.Repository}}
				{{else}}
					â€¦ {{/* will be loaded again by LastCommitLoaderURL */}}
				{{end}}
			</div>
			<div class="repo-file-cell age">{{if $commit}}{{DateUtils.TimeSince $commit.Committer.When}}{{end}}</div>
		</div>
	{{end}}
</div>

{{/* Simple JavaScript for download functionality */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle folder download button clicks
    document.querySelectorAll('.repo-download-folder-icon').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const downloadPath = this.getAttribute('data-download-path');
            const branch = this.getAttribute('data-branch');
            
            // Default to ZIP format
            let url = '{{$.RepoLink}}/download/folder';
            if (branch) {
                url += '/branch/' + encodeURIComponent(branch);
            }
            url += '/' + encodeURIComponent(downloadPath) + '?format=zip';
            
            // Start download
            window.location.href = url;
        });
        
        // Add context menu for format selection
        button.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const downloadPath = this.getAttribute('data-download-path');
            const branch = this.getAttribute('data-branch');
            const repoLink = '{{$.RepoLink}}';
            
            // Create simple context menu
            const menu = document.createElement('div');
            menu.className = 'ui menu compact';
            menu.style.cssText = 'position: absolute; z-index: 1000; background: white; border: 1px solid #e1e4e8; border-radius: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.12);';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            
            // Build base URL
            let baseUrl = repoLink + '/download/folder';
            if (branch) {
                baseUrl += '/branch/' + encodeURIComponent(branch);
            }
            baseUrl += '/' + encodeURIComponent(downloadPath);
            
            // Add format options
            const formats = [
                { name: 'ZIP', icon: 'octicon-file-zip', format: 'zip' },
                { name: 'TAR', icon: 'octicon-file-binary', format: 'tar' },
                { name: 'TAR.GZ', icon: 'octicon-file-zip', format: 'tar.gz' }
            ];
            
            formats.forEach(function(format) {
                const item = document.createElement('a');
                item.className = 'item';
                item.href = baseUrl + '?format=' + format.format;
                item.innerHTML = `
                    <span style="display: inline-flex; align-items: center;">
                        ${createSvg(format.icon, 16, 'margin-right: 8px;')}
                        ${format.name}
                    </span>
                `;
                menu.appendChild(item);
            });
            
            // Add to document and remove on click outside
            document.body.appendChild(menu);
            
            const removeMenu = function() {
                if (menu.parentNode) {
                    menu.parentNode.removeChild(menu);
                }
                document.removeEventListener('click', removeMenu);
            };
            
            setTimeout(function() {
                document.addEventListener('click', removeMenu);
            }, 0);
        });
    });
    
    // Helper function to create SVG
    function createSvg(icon, size, style) {
        return `<svg class="octicon" width="${size}" height="${size}" style="${style || ''}">
            <use xlink:href="#${icon}"></use>
        </svg>`;
    }
});
</script>