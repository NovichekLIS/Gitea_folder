{{/* use grid layout, still use the old ID because there are many other CSS styles depending on this ID */}}
<div id="repo-files-table" {{if .HasFilesWithoutLatestCommit}}hx-indicator="#repo-files-table .repo-file-cell.message" hx-trigger="load" hx-swap="morph" hx-post="{{.LastCommitLoaderURL}}"{{end}}>
	<div class="repo-file-line repo-file-last-commit">
		{{template "repo/latest_commit" .}}
		<div>{{if and .LatestCommit .LatestCommit.Committer}}{{DateUtils.TimeSince .LatestCommit.Committer.When}}{{end}}</div>
	</div>
	
	{{$.FileIconPoolHTML}}
	{{if .HasParentPath}}
	<a class="repo-file-line parent-link silenced" href="{{.BranchLink}}{{if .ParentPath}}{{PathEscapeSegments .ParentPath}}{{end}}">
		{{index $.FileIcons ".."}} ..
	</a>
	{{end}}
	{{range $item := .Files}}
		<div class="repo-file-item">
			{{$entry := $item.Entry}}
			{{$commit := $item.Commit}}
			{{$submoduleFile := $item.SubmoduleFile}}
			<div class="repo-file-cell name muted-links {{if not $commit}}notready{{end}}">
				{{if $entry.IsDir}}
					{{$subJumpablePathName := $entry.GetSubJumpablePathName}}
					
					{{/* Extract current branch from BranchLink */}}
					{{$currentBranch := ""}}
					{{if $.BranchLink}}
						{{$parts := StringUtils.Split $.BranchLink "/"}}
						{{range $i, $part := $parts}}
							{{if eq $part "branch"}}
								{{if lt (Eval $i "+" 1) (len $parts)}}
									{{$currentBranch = index $parts (Eval $i "+" 1)}}
								{{end}}
							{{end}}
						{{end}}
					{{end}}
					
					{{/* Compact folder download button */}}
					<div class="repo-download-folder-wrapper">
						<button class="ui basic compact icon button repo-download-folder-inline" 
								data-tooltip-content='{{ctx.Locale.Tr "repo.download_folder"}}'
								title='{{ctx.Locale.Tr "repo.download_folder"}}'
								type="button">
							{{svg "octicon-download" 14}}
						</button>
						<div class="repo-download-menu">
							{{/* Build download path */}}
							{{$downloadPath := ""}}
							{{if $.TreePath}}
								{{$downloadPath = printf "%s/%s" $.TreePath $entry.Name}}
							{{else}}
								{{$downloadPath = $entry.Name}}
							{{end}}
							{{$escapedPath := PathEscapeSegments $downloadPath}}
							
							{{/* Build URL with branch */}}
							{{$branchPrefix := ""}}
							{{if $currentBranch}}
								{{$branchPrefix = printf "/branch/%s/" $currentBranch}}
							{{end}}
							
							<a class="item" href="{{$.RepoLink}}/download/folder{{$branchPrefix}}{{$escapedPath}}?format=zip">
								{{svg "octicon-file-zip" 16 "tw-mr-2"}}ZIP
							</a>
							<a class="item" href="{{$.RepoLink}}/download/folder{{$branchPrefix}}{{$escapedPath}}?format=tar">
								{{svg "octicon-file-binary" 16 "tw-mr-2"}}TAR
							</a>
							<a class="item" href="{{$.RepoLink}}/download/folder{{$branchPrefix}}{{$escapedPath}}?format=tar.gz">
								{{svg "octicon-file-zip" 16 "tw-mr-2"}}TAR.GZ
							</a>
						</div>
					</div>
				{{end}}
				
				{{index $.FileIcons $entry.Name}}
				{{if $entry.IsSubModule}}
					{{$submoduleLink := $submoduleFile.SubmoduleWebLinkTree ctx}}
					{{if $submoduleLink}}
						<a class="entry-name" href="{{$submoduleLink.RepoWebLink}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						@ <a class="text primary" href="{{$submoduleLink.CommitWebLink}}">{{ShortSha $submoduleFile.RefID}}</a>
					{{else}}
						<span class="entry-name" title="{{$entry.Name}}">{{$entry.Name}}</span>
						@ {{ShortSha $submoduleFile.RefID}}
					{{end}}
				{{else}}
					{{if $entry.IsDir}}
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $subJumpablePathName}}" title="{{$subJumpablePathName}}">
							{{$subJumpablePathFields := StringUtils.Split $subJumpablePathName "/"}}
							{{$subJumpablePathFieldLast := (Eval (len $subJumpablePathFields) "-" 1)}}
							{{if eq $subJumpablePathFieldLast 0}}
								{{$subJumpablePathName}}
							{{else}}
								{{$subJumpablePathPrefixes := slice $subJumpablePathFields 0 $subJumpablePathFieldLast}}
								<span class="text light-2">{{StringUtils.Join $subJumpablePathPrefixes "/"}}</span>/{{index $subJumpablePathFields $subJumpablePathFieldLast}}
							{{end}}
						</a>
					{{else}}
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						{{if $entry.IsLink}}
							<a class="entry-symbol-link flex-text-inline" data-tooltip-content title="{{ctx.Locale.Tr "repo.find_file.follow_symlink"}}" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}?follow_symlink=1">{{svg "octicon-link" 12}}</a>
						{{end}}
					{{end}}
				{{end}}
			</div>
			<div class="repo-file-cell message commit-summary loading-icon-2px">
				{{if $commit}}
					{{$commitLink := printf "%s/commit/%s" $.RepoLink (PathEscape $commit.ID.String)}}
					{{ctx.RenderUtils.RenderCommitMessageLinkSubject $commit.Message $commitLink $.Repository}}
				{{else}}
					â€¦ {{/* will be loaded again by LastCommitLoaderURL */}}
				{{end}}
			</div>
			<div class="repo-file-cell age">{{if $commit}}{{DateUtils.TimeSince $commit.Committer.When}}{{end}}</div>
		</div>
	{{end}}
</div>

<style>
.repo-download-folder-wrapper {
    display: inline-block;
    position: relative;
    margin-right: 8px;
    vertical-align: middle;
}

.repo-download-folder-inline {
    padding: 2px 4px !important;
    margin: 0 !important;
    border: 1px solid #d0d7de !important;
    border-radius: 6px !important;
    cursor: pointer;
    width: 26px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #f6f8fa !important;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.repo-download-folder-inline:hover {
    opacity: 1;
    background-color: #ffffff !important;
    border-color: #8c959f !important;
    box-shadow: 0 1px 0 rgba(27, 31, 35, 0.04);
}

.repo-download-folder-inline svg {
    width: 14px;
    height: 14px;
    color: #57606a;
}

.repo-download-folder-inline:hover svg {
    color: #0969da;
}

.repo-download-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #ffffff;
    min-width: 140px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 4px 0;
    margin-top: 2px;
    overflow: hidden;
}

.repo-download-folder-wrapper:hover .repo-download-menu {
    display: block;
}

.repo-download-menu .item {
    display: flex;
    align-items: center;
    padding: 6px 12px;
    white-space: nowrap;
    color: #24292f;
    text-decoration: none;
    font-size: 13px;
    transition: background-color 0.1s ease;
}

.repo-download-menu .item:hover {
    background-color: #0969da;
    color: #ffffff;
}

.repo-download-menu .item:hover svg {
    color: #ffffff;
}

.repo-download-menu .item svg {
    width: 14px;
    height: 14px;
    margin-right: 8px;
    color: #57606a;
}

/* Ensure menu appears above other elements */
.repo-file-cell {
    position: relative;
    overflow: visible !important;
}

.repo-file-item {
    position: relative;
    overflow: visible !important;
}

@media (max-width: 768px) {
    .repo-download-folder-wrapper {
        margin-right: 4px;
    }
    
    .repo-download-folder-inline {
        width: 24px;
        height: 20px;
        padding: 1px 3px !important;
    }
    
    .repo-download-folder-inline svg {
        width: 12px;
        height: 12px;
    }
    
    .repo-download-menu {
        min-width: 120px;
        font-size: 12px;
    }
    
    .repo-download-menu .item {
        padding: 5px 10px;
    }
}
</style>