{{/* use grid layout, still use the old ID because there are many other CSS styles depending on this ID */}}
<div id="repo-files-table" {{if .HasFilesWithoutLatestCommit}}hx-indicator="#repo-files-table .repo-file-cell.message" hx-trigger="load" hx-swap="morph" hx-post="{{.LastCommitLoaderURL}}"{{end}}>
	<div class="repo-file-line repo-file-last-commit">
		{{template "repo/latest_commit" .}}
		<div>{{if and .LatestCommit .LatestCommit.Committer}}{{DateUtils.TimeSince .LatestCommit.Committer.When}}{{end}}</div>
	</div>
	{{$.FileIconPoolHTML}}
	{{if .HasParentPath}}
	<a class="repo-file-line parent-link silenced" href="{{.BranchLink}}{{if .ParentPath}}{{PathEscapeSegments .ParentPath}}{{end}}">
		{{index $.FileIcons ".."}} ..
	</a>
	{{end}}
	{{range $item := .Files}}
		<div class="repo-file-item">
			{{$entry := $item.Entry}}
			{{$commit := $item.Commit}}
			{{$submoduleFile := $item.SubmoduleFile}}
			<div class="repo-file-cell name muted-links {{if not $commit}}notready{{end}}">
				{{index $.FileIcons $entry.Name}}
				{{if $entry.IsSubModule}}
					{{$submoduleLink := $submoduleFile.SubmoduleWebLinkTree ctx}}
					{{if $submoduleLink}}
						<a class="entry-name" href="{{$submoduleLink.RepoWebLink}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						@ <a class="text primary" href="{{$submoduleLink.CommitWebLink}}">{{ShortSha $submoduleFile.RefID}}</a>
					{{else}}
						<span class="entry-name" title="{{$entry.Name}}">{{$entry.Name}}</span>
						@ {{ShortSha $submoduleFile.RefID}}
					{{end}}
				{{else}}
					{{if $entry.IsDir}}
						{{$subJumpablePathName := $entry.GetSubJumpablePathName}}
						
						{{/* Выпадающее меню для скачивания папки */}}
						<div class="download-folder-dropdown">
							<button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false" data-tooltip-content='{{ctx.Locale.Tr "repo.download_folder"}}' title='{{ctx.Locale.Tr "repo.download_folder"}}'>
								⬇️
							</button>
							<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
								{{/* Формируем базовый путь для скачивания */}}
								{{$downloadPath := ""}}
								{{if $.TreePath}}
									{{$downloadPath = printf "%s/%s" $.TreePath $entry.Name}}
								{{else}}
									{{$downloadPath = $entry.Name}}
								{{end}}
								{{$escapedPath := PathEscapeSegments $downloadPath}}
								
								<a class="dropdown-item" href="{{$.RepoLink}}/download/folder/zip/{{$escapedPath}}">
									<i class="octicon octicon-file-zip"></i> ZIP
								</a>
								<a class="dropdown-item" href="{{$.RepoLink}}/download/folder/tar/{{$escapedPath}}">
									<i class="octicon octicon-file-binary"></i> TAR
								</a>
								<a class="dropdown-item" href="{{$.RepoLink}}/download/folder/tar.gz/{{$escapedPath}}">
									<i class="octicon octicon-file-zip"></i> TAR.GZ
								</a>
							</div>
						</div>
						
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $subJumpablePathName}}" title="{{$subJumpablePathName}}">
							{{$subJumpablePathFields := StringUtils.Split $subJumpablePathName "/"}}
							{{$subJumpablePathFieldLast := (Eval (len $subJumpablePathFields) "-" 1)}}
							{{if eq $subJumpablePathFieldLast 0}}
								{{$subJumpablePathName}}
							{{else}}
								{{$subJumpablePathPrefixes := slice $subJumpablePathFields 0 $subJumpablePathFieldLast}}
								<span class="text light-2">{{StringUtils.Join $subJumpablePathPrefixes "/"}}</span>/{{index $subJumpablePathFields $subJumpablePathFieldLast}}
							{{end}}
						</a>
					{{else}}
						<a class="entry-name" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}" title="{{$entry.Name}}">{{$entry.Name}}</a>
						{{if $entry.IsLink}}
							<a class="entry-symbol-link flex-text-inline" data-tooltip-content title="{{ctx.Locale.Tr "repo.find_file.follow_symlink"}}" href="{{$.TreeLink}}/{{PathEscapeSegments $entry.Name}}?follow_symlink=1">{{svg "octicon-link" 12}}</a>
						{{end}}
					{{end}}
				{{end}}
			</div>
			<div class="repo-file-cell message commit-summary loading-icon-2px">
				{{if $commit}}
					{{$commitLink := printf "%s/commit/%s" $.RepoLink (PathEscape $commit.ID.String)}}
					{{ctx.RenderUtils.RenderCommitMessageLinkSubject $commit.Message $commitLink $.Repository}}
				{{else}}
					… {{/* will be loaded again by LastCommitLoaderURL */}}
				{{end}}
			</div>
			<div class="repo-file-cell age">{{if $commit}}{{DateUtils.TimeSince $commit.Committer.When}}{{end}}</div>
		</div>
	{{end}}
</div>

<style>
/* Исправленные стили для выпадающего меню */
.download-folder-dropdown {
    display: inline-block;
    position: relative;
    margin-right: 8px;
    vertical-align: middle;
    z-index: 1000; /* Добавлено */
}

.download-folder-dropdown .dropdown-toggle {
    background: none;
    border: 1px solid transparent;
    padding: 4px 6px;
    cursor: pointer;
    font-size: 14px;
    color: #586069;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 3px;
    transition: all 0.2s ease;
    position: relative; /* Добавлено */
    z-index: 1001; /* Добавлено */
}

.download-folder-dropdown .dropdown-toggle:hover {
    color: #0366d6;
    background-color: #f6f8fa;
    border-color: #e1e4e8;
}

.download-folder-dropdown .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #ffffff;
    min-width: 200px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    z-index: 10000; /* Увеличено */
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 8px 0;
    margin-top: 4px;
    transform: translateX(-25%); /* Центрирование под кнопкой */
}

.download-folder-dropdown:hover .dropdown-menu {
    display: block;
}

/* Убедимся, что родительские элементы не обрезают меню */
.repo-file-cell.name {
    position: static !important; /* Изменено с relative на static */
    overflow: visible !important; /* Добавлено */
    z-index: auto !important; /* Добавлено */
}

.repo-file-item {
    position: static !important; /* Изменено с relative на static */
    overflow: visible !important; /* Добавлено */
    z-index: auto !important; /* Добавлено */
}

#repo-files-table {
    position: relative; /* Добавлено для контекста */
    overflow: visible !important; /* Добавлено */
    z-index: auto !important; /* Добавлено */
}

.download-folder-dropdown .dropdown-item {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    color: #24292e;
    text-decoration: none;
    font-size: 14px;
    line-height: 1.5;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.download-folder-dropdown .dropdown-item:hover {
    background-color: #f6f8fa;
    color: #0366d6;
}

.download-folder-dropdown .dropdown-item i {
    margin-right: 10px;
    width: 16px;
    text-align: center;
    color: #6a737d;
}

.download-folder-dropdown .dropdown-item:hover i {
    color: #0366d6;
}

/* Для мобильных устройств - сохраняем предыдущие стили */
@media (max-width: 768px) {
    .download-folder-dropdown .dropdown-menu {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 300px;
        z-index: 100000; /* Очень высокий для мобильных */
    }
    
    /* На мобильных добавляем затемнение фона */
    .download-folder-dropdown:hover::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99999;
    }
}